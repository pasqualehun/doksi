%----------------------------------------------------------------------------
\chapter{Tervezés}
%----------------------------------------------------------------------------
\section{Kommunikáció}

A kommunikáció csatornánként 2 db modem segítségével történik, a modemek egymás közt vezeték nélkül csatlakoznak, felhasználói oldalon soros portot biztosítanak. Így az elkészítendõ programnak elég csak a soros port jeleinek vételével foglalkoznia. A modemek adatátviteli sebessége változó lehet, így azt a felhasználó egy listából választhatja csatlakozás elõtt.

\section{Adatok fogadása}

A redundanciából következõen külön, külön kell kezelni a 2 párhuzamos csatornán kapott adatokat. Mivel aszinkron módon érkeznek a csomagok, így kettõ tároló kell, mely a legutóbb küldötteket tárolja. 

\subsection{Protokoll}

Az adatokat a repülõgép 2 Hz-s frekvenciával küldi, ezek csomagokban érkeznek, melyeknek a felépítése:

\begin{table}[H]
	\begin{center}
			\begin{tabular}{| l | l | l | l |l |}
				\hline    bájt index 	& leírás 				& típus 				& skálázás 		& offset \\ \hline
					1 					& start 				& char(fix 'U') &   					&    						 \\ \hline
					2 					& start 				& char(fix 'U') &   					&    						 \\ \hline
					3						& start 				& char(fix 'T') &   					&    						 \\ \hline
					4 					& idõ  					& uint32 				& 10000 			& 0  						 \\ \hline
					8 					& magasság 			& uin16 				& 0x7fff/1000	&    						 \\ \hline
					\dots 			&   						&   						&   					&    						 \\ \hline
					TODO & északi irány 1/2 & unsigned short & 0x7FFF/400 &  200 \\ \hline
					28 & keleti irány 1/2 & unsigned short & 0x7FFF/400 &  200 \\ \hline
					30 & lefelé irány 1/2 & unsigned short & 0x7FFF/400 &  200 \\ \hline
				
					\dots &   &   &   &    \\ \hline
				\end{tabular}
	\end{center}
	\caption{Fogadás protokollja}
	\label{tab:down}
\end{table}

A skálázás és offset képzés azért szükséges, hogy az adott szélességen (8, 16, 32 bit) minél több biten legyen ábrázolva egy érték, mivel kis változások esetén a Hamming-távolság\footnote{Bináris számok XOR képzésével kapott 1-esek száma} kicsi lenne az eredeti számábrázoláson. Ahol szükséges, ott a  visszakódolás az alábbi formában történik : \\
$eredeti  = (nyers adat/skalazas) - offset $ \\
Az értékek megfelelõ kiválasztása a minél nagyobb szétszóráshoz szükséges.

\section{Adatok küldése}

A repülõgép által lerepülendõ feladat útvonalpontjait hasonlóképpen, mint az adatok fogadását, vezeték nélküli csatornán küldjük fel. A feltöltendõ adat küldésének protokollja létfontosságú, mivel ha valamilyen hiba kerül a kommunikációba akkor az akár végzetes is lehet. Gondolok itt olyan hibára, hogy egy fordulópont koordinátája úgy kerül feltöltésre, hogy az kiesik a repülõ hatósugarából és ezzel nem számolva, lemerül a tápellátást szolgáló akkumulátor. Az ilyen hibák ellen célszerû a feltöltés protokolljába hibadetektálást építeni, hogy ezek a feldolgozás( esetlegesen felszállás ) elõtt kiderüljenek ki.


\subsection{Protokoll}

Több megoldás is lehetséges a fordulópontok feltöltésére:
\begin{itemize}
\item Rögzített maximális darabszám elküldése egy csomagban
\item Változó darabszám esetén egy fordulópont egy csomagban
\end{itemize}


Az elsõ megoldásban rögzítenénk a fordulópontok maximális számát. Mely azt eredményezné, hogy egy csomagban el lehetne küldeni az egész lerepülendõ feladatot. Ha egy pont koordinátájának ábrázolására elég 2*4 byte, így ha feltételezünk egy MAXPOINT byte-os csomagot, akkor abba beleférne kb. MAXPOINT darab. Egy csomag állna egy fejlécbõl, a feltöltendõ pontok számából, a pontokból, és egy checkszámból. 

Másik lehetõségnél N db-t lehetne feltölteni: egy csomag szerkezete: fejléc, küldendõ pontok száma, aktuális pont sorszáma, koordinátái, checkszám. Ha a  küldendõ pontok száma és az aktuális pont sorszáma megegyezik és megérkezett minden csomag akkor ACK-val válaszol ha kész a feltöltés. 


Mivel az eddig használt megoldásban a kódba ,,bele volt égetve'' az útvonalterv, mely 5-6 pontot tartalmazott, az elsõ megoldás tûnik kedvezõbbnek. Fogadó oldalon is könnyebb egy ilyen lehetõségre felkészíteni. Ha esetlegesen a jövõben több fordulópontont feltöltésére lesz igény, az is megoldható kis módosítással.

A modem is duplikált, így a 2 soros portra csatlakoztatott modemmel redundánsan küldjük el a csomagot. TODO TODO??? Ha a csomag sértetlenül megérkezett, ACK jelzéssel válaszol.
\begin{table}
	\begin{center}
			\begin{tabular}{| l | l | l | l |l |}
				\hline
				bájt index 	& leírás 				& típus 				& skálázás 		& offset  \\ \hline
				0 					& start 				& bájt(fix 'G') &   					&    			\\ \hline
				1 					& start 				& bájt(fix 'P') &   					&    			\\ \hline
				2						& start 				& bájt(fix 'S') &   					&    			\\ \hline
				3 					& pontok száma	& bájt    			& 			 			&    			\\ \hline
				4 					& pontok[0].lat & uin32 				& 0x7fff/360	&  180		\\ \hline
				\dots 			&   						&   						&   					&    			\\ \hline
				8 					& pontok[0].lon & uin32 				& 0x7fff/360	&  180		\\ \hline
				\dots 			&   						&   						&   					&    			\\ \hline
				12 					& pontok[1].lat & uin32 				& 0x7fff/360	&  180		\\ \hline
				\dots 			&   						&   						&   					&    			\\ \hline
				16 					& pontok[1].lon & uin32 				& 0x7fff/360	&  180		\\ \hline
				\dots 			&   						&   						&   					&    			\\ \hline
				78 					& checksum 1/2	& uin16 				& 						&  				\\ \hline
				79 					& checksum 2/2 	& uin16 				& 						&  				\\ \hline

			\end{tabular}
	\end{center}
	\caption{Küldés protokollja}
	\label{tab:up}
\end{table}

\section{Grafikus felület}

Az elõzõ fejezetben ismertetett grafikus felületekbõl levonva a következtetéseket, nyilvánvaló, hogy a GUI kialakításában fontos a repülõgép aktuális pozíciójának térképen való mutatása, az repülési állapot könnyen értelmezhetõ megjelenítése, illetve az esetlegesen elõforduló problémák feltûnõ jelzése.

\subsection{Fõképernyõ}

A fõképernyõn látható lesz a repülõgép aktuális pozíciója és iránya. A pozicionálást segítendõ, egy térkép lesz egy repülõgép ikon hátterében. Ez a rész a képernyõ kb. 2/3-át fogja elfoglalni. Az oldalsó sávban a ``Glass Cockpit'' kerül kialakításra, ez egy mûhorizont, mely a gép által küldött orientációs adatokból az operátor számára informatívan ábrázolja a repülési állapotot. Ez a nézet tartalmazza még a gép aktuális sebességét, irányát, melyet egy iránytû segítségével láthat. Valószínûleg ez a képernyõ lesz legnagyobb százalékban használva, így a kritikus hibákról itt kell feltûnõ értesítést adni.

\subsection{Tervezés képernyõ}

Ezen a képernyõn a felhasználó kijelölheti a lerepülendõ útvonalhoz tartozó fordulópontokat, melyet csatlakozás után aszinkron módon feltölthet a repülõre. Mivel a kommunikációs protokoll MAXPOINT pontot enged meg, így ennél többet itt ki sem jelölhet, a lerakott pontok helyét a megszokott Google Maps-hoz hasonló módon hosszan kattintva átrakhatónak kell lennie, illetve köztes pontoknak törölhetõeknek kell lenniük.

\subsection{Diagnosztikai képernyõ}

A 2 porton érkezõ dekódolt értékek látszódnának 2 oszlopban, mellettük egy hibaérték, mely a különbözõ hibatípusok hibaszámának összege lenne. 

\subsubsection{Hibatípusok}
\begin{itemize}
\item beragadás
\item túl nagy változás
\item túl nagy különbség a 2 vett értéken
\end{itemize}

Ezek feldolgozására 2 FIFO sort kell alkalmazni, melyek visszamenõleg tárolják a beérkezõ értékeket. Ez azért szükséges, mivel így a túlságosan kiugró értékeket detektálni lehet, illetve, ha az egész sorban ugyanazok az értékek vannak, gyanús a beragadás esélye.
A harmadik esetben sajnos nem lehetséges a ``jó'' kiválasztása, mivel nem tudjuk, melyik modembõl érkezett adat a megfelelõ. Ezt csak háromszorozással és többségi szavazással lehetne megoldani.

